name: üß™ CI cho Microservices (Backend)

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  detect-changes:
    name: üîç Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      changed_services: ${{ steps.detect.outputs.changed_services }}

    steps:
      - name: üì¶ Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: üîç Detect changed folders
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          echo "üîç Detecting changed services..."

          # N·∫øu kh√¥ng c√≥ commit tr∆∞·ªõc (v√≠ d·ª• push ƒë·∫ßu ti√™n), build t·∫•t c·∫£
          if ! git rev-parse HEAD~1 >/dev/null 2>&1; then
            echo "‚ö†Ô∏è No previous commit -> build all services"
            CHANGED="services/"
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD || echo "")
          fi

          echo "Changed files:"
          echo "$CHANGED"

          SERVICES=()

          # L·∫•y danh s√°ch th∆∞ m·ª•c trong services/
          for folder in services/*; do
            [ -d "$folder" ] || continue
            svc=$(basename "$folder")
            if echo "$CHANGED" | grep -q "^services/$svc/"; then
              SERVICES+=("$svc")
            fi
          done

          # N·∫øu kh√¥ng ph√°t hi·ªán thay ƒë·ªïi, build t·∫•t c·∫£
          if [ ${#SERVICES[@]} -eq 0 ]; then
            SERVICES=("api-gateway" "auth-service" "team-service")
          fi

          # T·∫°o JSON h·ª£p l·ªá (m·ªôt d√≤ng, v√≠ d·ª•: ["api-gateway","auth-service"])
          JSON="["
          first=true
          for s in "${SERVICES[@]}"; do
            if [ "$first" = true ]; then
              JSON="$JSON\"$s\""
              first=false
            else
              JSON="$JSON,\"$s\""
            fi
          done
          JSON="$JSON]"

          # Hi·ªÉn th·ªã ƒë·ªÉ debug (log)
          echo "Detected services JSON: $JSON"

          # Ghi output an to√†n theo ƒë·ªãnh d·∫°ng multi-line ƒë·ªÉ tr√°nh newline/escaping issues
          echo "changed_services<<EOF" >> "$GITHUB_OUTPUT"
          echo "$JSON" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      # (kh√¥ng c·∫ßn b∆∞·ªõc set-output kh√°c; s·ª≠ d·ª•ng outputs tr√™n job)
  
  build-and-test:
    name: ‚öôÔ∏è Build & Test Microservices
    runs-on: ubuntu-latest
    needs: detect-changes

    strategy:
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.changed_services) }}
      max-parallel: 3
      fail-fast: false

    steps:
      - name: üì¶ Checkout source code
        uses: actions/checkout@v4

      - name: üß∞ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # cache-dependency-path ch·ªâ d√πng n·∫øu b·∫°n ƒë√£ commit package-lock.json trong t·ª´ng service
          cache: 'npm'
          cache-dependency-path: services/${{ matrix.service }}/package-lock.json

      - name: üîß Install dependencies
        working-directory: services/${{ matrix.service }}
        run: |
          if [ -f package-lock.json ]; then
            npm ci || npm install
          else
            npm install
          fi

      - name: ‚úÖ Lint, Build & Test
        working-directory: services/${{ matrix.service }}
        run: |
          npm run lint --if-present
          npm run build --if-present
          npm test --if-present

      - name: üê≥ Build Docker image (if Dockerfile present)
        run: |
          SERVICE_PATH="${{ github.workspace }}/services/${{ matrix.service }}"
          if [ -f "$SERVICE_PATH/Dockerfile" ]; then
            docker build -t "${{ matrix.service }}" "$SERVICE_PATH"
          else
            echo "‚ö†Ô∏è Dockerfile not found for ${{ matrix.service }} ‚Äî skipping docker build"
          fi

  compose-validate:
    name: üß© Validate Docker Compose
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: üì¶ Checkout source code
        uses: actions/checkout@v4

      - name: üê≥ Docker Compose Config Check
        run: |
          if [ -f docker-compose.yml ]; then
            docker compose config
          else
            echo "‚ö†Ô∏è docker-compose.yml not present ‚Äî skipping compose check"
          fi
